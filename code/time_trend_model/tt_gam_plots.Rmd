---
title: "RR-TB Updates: September 28, 2023"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include = FALSE, messages = FALSE, warning = FALSE}
source(here::here("code/dependencies.R"))

library(mgcv)
library(gratia)
library(itsadug)
library(tidygam)

load(here::here("data/sinan_xpert.Rdata"))

load(here::here("data/mdf_new_grp.Rdata"))
load(here::here("data/mdf_new_ind.Rdata"))
load(here::here("data/mdf_reentry_ind.Rdata"))
load(here::here("data/mdf_relapse_ind.Rdata"))
load(here::here("data/mdf_grp_diag.Rdata"))


options(dplyr.summarise.inform = FALSE)


# Load all model fits from "tt_gam_models.R"
load(here::here("output/fits/mod1_new.rda"))
load(here::here("output/fits/mod2_new.rda"))
load(here::here("output/fits/mod3_new.rda"))
load(here::here("output/fits/mod4_all.rda"))
load(here::here("output/fits/mod5_all.rda"))

# load(here::here("output/fits/new_adjusted.rda"))
# load(here::here("output/fits/new_adjusted_hu.Rda"))
# load(here::here("output/fits/new_adjusted_hu_fhs.rda"))
# load(here::here("output/fits/new_adjusted_post2015.Rda"))

load(here::here("output/fits/reentry_null.Rda"))
load(here::here("output/fits/reentry_adjusted.Rda"))
load(here::here("output/fits/reentry_adjusted_post2015.Rda"))

load(here::here("output/fits/relapse_null.Rda"))
load(here::here("output/fits/relapse_adjusted.Rda"))
load(here::here("output/fits/relapse_adjusted_post2015.Rda"))
```


# Project Aim
* Back out trends in the prevalence of Rifampicin resistant TB (RR-TB) over time using Xpert testing data in Sinan
* Develop a relatively simple model that accounts for variation in roll-out of Xpert over time and across geographies (e.g. by state), as well as potential bias in who is getting tested with Xpert


## Helpful context: Trends in Xpert testing overtime
```{r testing over time, echo=FALSE, fig.height= 12, fig.width= 20, warning=FALSE, messages=FALSE}
sinan_xpert %>% 
  group_by(diag_qrt, state_nm) %>% 
  filter(!is.na(state_nm)) %>% 
  summarize(pct_tested = sum(test_molec %in% c("1", "2", "3", "4")/n()), 
            pct_result = if_else(is.nan(sum(test_molec %in% c("1", "2")/sum(test_molec %in% c("1", "2", "3", "4")))),0, sum(test_molec %in% c("1", "2")/sum(test_molec %in% c("1", "2", "3", "4")))), 
            pct_not_detect = if_else(is.nan(sum(test_molec %in% c("3")/sum(test_molec %in% c("1", "2", "3", "4")))),0, sum(test_molec %in% c("3")/sum(test_molec %in% c("1", "2", "3", "4")))), 
            pct_inconclusive = if_else(is.nan(sum(test_molec %in% c("4")/sum(test_molec %in% c("1", "2", "3", "4")))),0, sum(test_molec %in% c("4")/sum(test_molec %in% c("1", "2", "3", "4"))))
            ) %>% 
  ggplot() + 
  geom_line(aes(x = diag_qrt, y = pct_tested, group = state_nm, color = "Share of cases tested with Xpert")) + 
   geom_line(aes(x = diag_qrt, y = pct_result, group = state_nm, color = "Share of tests with result")) + 
   geom_line(aes(x = diag_qrt, y = pct_not_detect, group = state_nm, color = "Not detect")) + 
   geom_line(aes(x = diag_qrt, y = pct_inconclusive, group = state_nm, color = "Inconclusive")) + 
  xlab("Quarter") + 
  ylab("Percent") + 
  ggtitle("Trends in Xpert testing by state and quarter") + 
  facet_wrap(~state_nm) + 
    theme_bw() + 
    theme(strip.background = element_blank(),
        strip.text = element_text(size = 11),
        panel.spacing = unit(3, "pt"), 
        # legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12), 
        title = element_text(size = 12), 
        legend.key.height = unit(2, 'cm')) + 
  
  scale_color_manual(name="",
                   labels=c("Share of all TB cases \ntested with Xpert",
                            "Share of Xpert tests \nwith reported result"),
                   values=c("black", "red" ))

```

* As of 2019: 

   * ~ 40% of cases were being tested with Xpert, compared to ~ 3% in 2014 and 23.5% in 2015, on average
   
   * Mato Grosso, Pará, and Pernambuco had the lowest average testing coverage
   
   * Roraima, Amazonas, and Rondônia had the highest average testing coverage 


\newpage

# Model Specification

### Overview 
* State-level hierarchical generalized additive model (GAM) that models the prevalence of RR-TB positive cases per quarter among incident TB cases between 2014-2019

* Fit smoothing functions to reduce the noise we were seeing in previous models

* Models risk of positivity by characteristics of patient and municipality where they reside

  * Note: Between 2014-2019, ~3,300 cases diagnosed outside of patient's state of residence; ~88,000 cases diagnosed outside patient's municipality of residence

* Separate models for new TB cases, re-entry cases, and relapsed cases 



### Set Up
```{r model specification, eval = FALSE}
result ~ s(state, bs = "re") + s(time) + s(time, by = state, id = 1) + age_cat + 
  hiv_status + sex + health_unit + bf_cat + urban_cat + has_prison
```


* Random intercept for each state (patient state of residence)

* A different smooth function for time by state with a shared smoothing parameter

* Each state-level smoothing parameter varies around a grand smooth function for time to allow for pooling across states

* Fixed effects for patient-level characteristics: 

  * Age 
  * HIV status
  * Sex
  * Level of health unit of diagnosis - Based on CNES merge 
  
* Fixed effects for municipality-level characteristics: 

  * Urbanicity (cat) - Percent of the population in urban setting (2010 census)
  * Bolsa Familia coverage (cat) - Percent of the population benefiting from BF (BF: SAGICAD, 2018 - earliest year available; Denominator: 2010 Census)
  * Presence of prison during year (SISPEN)
  * FHS Coverage - Number of health teams per 4,000 people (Forthcoming)


### Specifications 

* Model 1 - Adjusted: 
  * Patient-level: HIV status, sex, age, health unit level
  * Municipality: BF coverage, urbanicity, presence of prison
  
* Model 2 - Adjusted; Restricted > 2015

* Run separately by case type (e.g. new, relapse, re-entry) and for all cases




\newpage


# Model Output

## New cases

* Model A - Adjusted: 
  * Patient-level: HIV status, sex, age (cat), health unit
  * Municipality: Pct average BF coverage (cat), pct pop in urban area, presence of prison
  
* Model B - Model A  + interaction term (HIV, sex, age)

* Model C - Model A, restricted to >2015 


```{r plot - 1-3, warning = FALSE, messages = FALSE, echo = FALSE, fig.height= 12, fig.width= 20}
# predict output
mod1_new_pred <- fitted_values(mod1_new, data = mdf_new_grp, scale = "response")
mod2_new_pred <- fitted_values(mod2_new, data = mdf_new_grp %>% filter(time > 8), scale = "response")
mod3_new_pred <- fitted_values(mod3_new, data = mdf_new_grp, scale = "response")

### Plot fitted models 
ggplot() +
  
  # add pct tested and scale by number tested
  geom_point(
    data = mdf_new_grp %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(Positive + Negative),
                obs_pct_pos = if_else(is.nan(sum(Positive)/sum(Positive + Negative)), 0, sum(Positive)/sum(Positive + Negative))),
    aes(x = time, y = obs_pct_pos, group = state_nm, size = num_tested), alpha = 0.5) +
  
  # Add in indications of when no cases were tested with xpert in a given period
  geom_point(data = mdf_new_grp %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(Positive + Negative),
                obs_pct_pos = if_else(is.nan(sum(Positive)/sum(Positive + Negative)), 0, sum(Positive)/sum(Positive + Negative))) %>% 
        filter(num_tested == 0),
      aes(x = time, y = num_tested), colour="black", shape=4, size=3) + 
  
  # add fitted values - Model 1 (Adjusted)
  geom_line(data = mod1_new_pred %>%
                filter(!is.na(fitted)) %>%
              group_by(state_nm, time) %>%
              summarize(fitted = sum(fitted*cases)/sum(cases)),
            aes(time, fitted, group = state_nm, color = "Model A - Adjusted")) +


  #   # add fitted values - Adjusted (+ interaction term)
  geom_line(data = mod3_new_pred %>%
                filter(!is.na(fitted)) %>%
              group_by(state_nm, time) %>%
              summarize(fitted = sum(fitted*cases)/sum(cases)),
            aes(time, fitted, group = state_nm, color = "Model B - Adjusted + HIV*Sex*Age")) +

     # add fitted values - Adjusted > 2015
  geom_line(data = mod2_new_pred %>%
                filter(!is.na(fitted)) %>%
              group_by(state_nm, time) %>%
              summarize(fitted = sum(fitted*cases)/sum(cases)),
            aes(time, fitted, group = state_nm, color = "Model C - Adjusted, >2015")) +

  
  xlab("Quarter") + 
  ylab("Percent positive") + 
  ggtitle("New Cases") + 
  facet_wrap(~state_nm, scales = "free") +    
  theme_bw() + 
    theme(strip.background = element_blank(),
        strip.text = element_text(size = 11),
        panel.spacing = unit(3, "pt"), 
        # legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12), 
        title = element_text(size = 12)) +
  scale_size(
    range = c(0.5, 5)
  ) +
  labs(size = "Number of cases tested (Observed)", 
       color = "Models", 
       caption = "Note: An X denotes that 0 cases were tested with Xpert in a given quarter.") + 
scale_fill_manual(values = c("Fitted")) +
scale_color_manual(name="Lines",
                   labels=c("Model A - Adjusted",
                            "Model B - Adjusted + HIV*Sex*Age", 
                            "Model C - Adjusted, >2015"),
                   values=c("black", "blue", "red"))

```

* Time trends in RR-TB positivity (Model A - Adjusted): 

  * 2017: 
    * Average: 0.04
    * Range: 0.015 (Sao Paulo) - 0.089 (Maranhão) 
    * São Paulo: 0.015
  
  * 2018: 
    * Average: 0.03
    * Range: 0.012 (Rio Grande do Norte) - 0.068 (Maranhão)
    * São Paulo: 0.015
  
  * 2019:
    * Average: 0.03
    * Range: 0.01 (Sergipe) - 0.045 (Maranhão)
    * São Paulo: 0.015



\newpage


# Re-Entry Cases
Note: The following figures show the same model output, only the Y axis changes to show variation within each state. 

## Fixed Axes
```{r plot - re-entry adjusted model FIXED, warning = FALSE, messages = FALSE, echo = FALSE, fig.height= 12, fig.width= 20}

### Predict output
reentry_null_fit <- fitted_values(reentry_null, data = mdf_reentry_ind, scale = "response")

reentry_adjusted_fit <- fitted_values(reentry_adjusted, data = mdf_reentry_ind, scale = "response")

reentry_adjusted_post2015_fit <- fitted_values(reentry_adjusted_post2015, data = mdf_reentry_ind %>% filter(time > 8), scale = "response") 



### Plot fitted model
ggplot() +
  
  # add pct tested and scale by number tested
  geom_point(
    data = mdf_reentry_ind %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(!is.na(result)),
                positive = sum(result == "1", na.rm = TRUE),
                obs_pct_pos = if_else(is.na(sum(result == "1", na.rm = TRUE)/num_tested), 0, sum(result == "1", na.rm = TRUE)/num_tested)),
    aes(x = time, y = obs_pct_pos, group = state_nm, size = num_tested), alpha = 0.3) +
  
    # Add in indications of when no cases were tested with xpert in a given period
  geom_point(
    data = mdf_reentry_ind %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(!is.na(result)),
                positive = sum(result == "1", na.rm = TRUE),
                obs_pct_pos = if_else(is.na(sum(result == "1", na.rm = TRUE)/num_tested), 0, sum(result == "1", na.rm = TRUE)/num_tested)) %>% 
        filter(num_tested == 0),
      aes(x = time, y = num_tested), colour="black", shape=4, size=3) + 
  
    # add fitted values
  geom_line(data = reentry_null_fit %>% 
                filter(!is.na(fitted)) %>% 
              group_by(state_nm, time) %>% 
            
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model A - Time trend only"))+
  
  # add fitted values
  geom_line(data = reentry_adjusted_fit %>% 
              filter(!is.na(fitted)) %>% 
              group_by(state_nm, time) %>% 
               
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model B - Adjusted"))+
  
    # add fitted values
  geom_line(data = reentry_adjusted_post2015_fit %>% 
               filter(!is.na(fitted)) %>% 
              group_by(state_nm, time) %>% 
              
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model C - Adjusted, >2015"))+
  
  xlab("Quarter") + 
  ylab("Percent positive") + 
  ggtitle("Re-entry (Fixed)") + 
  facet_wrap(~state_nm) + 
    theme_bw() + 
    theme(strip.background = element_blank(),
        strip.text = element_text(size = 11),
        panel.spacing = unit(3, "pt"), 
        # legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12), 
        title = element_text(size = 12)) +
  scale_size(
    range = c(0.5, 5)
  ) +
  labs(size = "Number of cases tested (Observed)", 
       color = "",
        caption = "Note: An X denotes that 0 cases were tested with Xpert in a given quarter.")  + 
scale_fill_manual(values = c("Fitted")) +
scale_color_manual(name="Lines",
                   labels=c("Model A - Time trend only", 
                            "Model B - Adjusted", 
                            "Model C - Adjusted, >2015"
                            ),
                   values=c("black", "red", "blue", "purple"))

```

## Varied Axes
```{r plot - re-entry adjusted model VARIED, warning = FALSE, messages = FALSE, echo = FALSE, fig.height= 12, fig.width= 20}


### Plot fitted model
ggplot() +
  
  # add pct tested and scale by number tested
  geom_point(
    data = mdf_reentry_ind %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(!is.na(result)),
                positive = sum(result == "1", na.rm = TRUE),
                obs_pct_pos = if_else(is.na(sum(result == "1", na.rm = TRUE)/num_tested), 0, sum(result == "1", na.rm = TRUE)/num_tested)),
    aes(x = time, y = obs_pct_pos, group = state_nm, size = num_tested), alpha = 0.3) +
  
      # Add in indications of when no cases were tested with xpert in a given period
  geom_point(
    data = mdf_reentry_ind %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(!is.na(result)),
                positive = sum(result == "1", na.rm = TRUE),
                obs_pct_pos = if_else(is.na(sum(result == "1", na.rm = TRUE)/num_tested), 0, sum(result == "1", na.rm = TRUE)/num_tested)) %>% 
        filter(num_tested == 0),
      aes(x = time, y = num_tested), colour="black", shape=4, size=3) + 
  
    # add fitted values
  geom_line(data = reentry_null_fit %>% 
              group_by(state_nm, time) %>% 
              filter(!is.na(fitted)) %>% 
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model A - Time trend only"))+
  
  # add fitted values
  geom_line(data = reentry_adjusted_fit %>% 
              group_by(state_nm, time) %>% 
               filter(!is.na(fitted)) %>% 
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model B - Adjusted"))+
  
    # add fitted values
  geom_line(data = reentry_adjusted_post2015_fit %>% 
              group_by(state_nm, time) %>% 
               filter(!is.na(fitted)) %>% 
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model C - Adjusted, >2015"))+
  
  xlab("Quarter") + 
  ylab("Percent positive") + 
  ggtitle("Re-entry (Varied)") + 
  facet_wrap(~state_nm, scales = "free") + 
    theme_bw() + 
    theme(strip.background = element_blank(),
        strip.text = element_text(size = 11),
        panel.spacing = unit(3, "pt"), 
        # legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12), 
        title = element_text(size = 12)) +
  scale_size(
    range = c(0.5, 5)
  ) +
  labs(size = "Number of cases tested (Observed)", 
       color = "",
       caption = "Note: An X denotes that 0 cases were tested with Xpert in a given quarter.")  + 
scale_fill_manual(values = c("Fitted")) +
scale_color_manual(name="Lines",
                   labels=c("Model A - Time trend only", 
                            "Model B - Adjusted", 
                            "Model C - Adjusted, >2015" 
                            ),
                   values=c("black", "red", "blue"))

```

* Time trends in RR-TB positivity (Model A - Adjusted): 

  * 2017: 
    * Average: 0.058
    * Range: 0.022 (Rio Grande do Norte) - 0.114 (Rio Grande do Sul)
    * São Paulo: 0.048
  
  * 2018: 
    * Average: 0.059
    * Range: 0.024 (Rio Grande do Norte) - 0.141 (Amapá)
    * São Paulo: 0.042
  
  * 2019: 
    * Average: 0.055
    * Range: 0.017 (Sergipe) - 0.217 (Amapá)
    * São Paulo: 0.0315


\newpage






# Relapse Cases
Note: The following figures show the same model output, only the Y axis changes to show variation within each state. 

## Fixed axes by state
```{r plot - relapse adjusted model FIXED, warning = FALSE, messages = FALSE, echo = FALSE, fig.height= 12, fig.width= 20}
### Predict output
relapse_null_fit <- fitted_values(relapse_null, data = mdf_relapse_ind, scale = "response") 

relapse_adjusted_fit <- fitted_values(relapse_adjusted, data = mdf_relapse_ind, scale = "response") 

relapse_adjusted_post2015_fit <- fitted_values(relapse_adjusted_post2015, data = mdf_relapse_ind %>% filter(time > 8), scale = "response")


### Plot fitted model
ggplot() +
  # add pct tested and scale by number tested
  geom_point(
    data = mdf_relapse_ind %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(!is.na(result)),
                positive = sum(result == "1", na.rm = TRUE),
                obs_pct_pos = if_else(is.na(sum(result == "1", na.rm = TRUE)/num_tested), 0, sum(result == "1", na.rm = TRUE)/num_tested)),
    aes(x = time, y = obs_pct_pos, group = state_nm, size = num_tested), alpha = 0.3) +
  
      # Add in indications of when no cases were tested with xpert in a given period
  geom_point(
    data = mdf_relapse_ind %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(!is.na(result)),
                positive = sum(result == "1", na.rm = TRUE),
                obs_pct_pos = if_else(is.na(sum(result == "1", na.rm = TRUE)/num_tested), 0, sum(result == "1", na.rm = TRUE)/num_tested)) %>% 
        filter(num_tested == 0),
      aes(x = time, y = num_tested), colour="black", shape=4, size=3) + 
  
  
    # add fitted values
  geom_line(data = relapse_null_fit %>% 
              filter(!is.na(fitted)) %>% 
              group_by(state_nm, time) %>% 
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model A - Time trend only"))+
  
  # add fitted values
  geom_line(data = relapse_adjusted_fit %>%
              filter(!is.na(fitted)) %>%
              group_by(state_nm, time) %>%
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model B - Adjusted"))+

    # add fitted values
  geom_line(data = relapse_adjusted_post2015_fit %>% 
              filter(!is.na(fitted)) %>% 
              group_by(state_nm, time) %>% 
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model C - Adjusted, > 2015")) +
  
  xlab("Quarter") + 
  ylab("Percent positive") + 
  ggtitle("Relapse (Fixed)") + 
  facet_wrap(~state_nm) + 
    theme_bw() + 
    theme(strip.background = element_blank(),
        strip.text = element_text(size = 11),
        panel.spacing = unit(3, "pt"), 
        # legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12), 
        title = element_text(size = 12))  + 
  scale_size(
    range = c(0.5, 5)
  ) +
  labs(size = "Number of cases tested (Observed)", color = "",
        caption = "Note: An X denotes that 0 cases were tested with Xpert in a given quarter.") + 
scale_fill_manual(values = c("Fitted")) +
scale_color_manual(name="Lines",
                   labels=c(
                     "Model A - Time trend only", 
                            "Model B - Adjusted",
                            "Model C - Adjusted, > 2015"),
                   values=c("black" ,"red","blue"))

```

## Varied axes by state
```{r plot - relapse adjusted model VARIED, warning = FALSE, messages = FALSE, echo = FALSE, fig.height= 12, fig.width= 20}

### Plot fitted model
ggplot() +
  # add pct tested and scale by number tested
  geom_point(
    data = mdf_relapse_ind %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(!is.na(result)),
                positive = sum(result == "1", na.rm = TRUE),
                obs_pct_pos = if_else(is.na(sum(result == "1", na.rm = TRUE)/num_tested), 0, sum(result == "1", na.rm = TRUE)/num_tested)),
    aes(x = time, y = obs_pct_pos, group = state_nm, size = num_tested), alpha = 0.3) +
  
        # Add in indications of when no cases were tested with xpert in a given period
  geom_point(
    data = mdf_relapse_ind %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(!is.na(result)),
                positive = sum(result == "1", na.rm = TRUE),
                obs_pct_pos = if_else(is.na(sum(result == "1", na.rm = TRUE)/num_tested), 0, sum(result == "1", na.rm = TRUE)/num_tested)) %>% 
        filter(num_tested == 0),
      aes(x = time, y = num_tested), colour="black", shape=4, size=3) + 
  
  
    # add fitted values
  geom_line(data = relapse_null_fit %>% 
              filter(!is.na(fitted)) %>% 
              group_by(state_nm, time) %>% 
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model A - Time trend only"))+
  
  # add fitted values
  geom_line(data = relapse_adjusted_fit %>%
              filter(!is.na(fitted)) %>%
              group_by(state_nm, time) %>%
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model B - Adjusted"))+

    # add fitted values
  geom_line(data = relapse_adjusted_post2015_fit %>% 
              filter(!is.na(fitted)) %>% 
              group_by(state_nm, time) %>% 
              summarize(fitted = sum(fitted)/n()), aes(time, fitted, group = state_nm, color = "Model C - Adjusted, > 2015")) +
  
  xlab("Quarter") + 
  ylab("Percent positive") + 
  ggtitle("Relapse (Varied)") + 
  facet_wrap(~state_nm, scales = "free") + 
    theme_bw() + 
    theme(strip.background = element_blank(),
        strip.text = element_text(size = 11),
        panel.spacing = unit(3, "pt"), 
        # legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12), 
        title = element_text(size = 12)) + 
  scale_size(
    range = c(0.5, 5)
  ) +
  labs(size = "Number of cases tested (Observed)", color = "",
        caption = "Note: An X denotes that 0 cases were tested with Xpert in a given quarter.") + 
scale_fill_manual(values = c("Fitted")) +
scale_color_manual(name="Lines",
                   labels=c(
                     "Model A - Time trend only", 
                            "Model B - Adjusted",
                            "Model C - Adjusted, > 2015"),
                   values=c("black" ,"red","blue"))

```

* Time trends in RR-TB positivity (Model A - Adjusted): 

  * 2017: 
    * Average: 0.063
    * Range: 0.036 (São Paulo) - 0.094 (Rio de Janeiro)
    * São Paulo: 0.036
  
  * 2018: 
    * Average: 0.065
    * Range: 0.031 (Pernambuco) - 0.116 (Maranhão)
    * São Paulo: 0.04
  
  * 2019: 
    * Average: 0.047
    * Range: 0.0132 (Pernambuco) - 0.109 (Maranhão)
    * São Paulo: 0.0311


\newpage 

# All cases (e.g. Diagnoses types combined)
```{r plot - all cases FIXED, echo=FALSE, fig.height= 12, fig.width= 20, warning=FALSE, messages=FALSE}
mod4_all_pred <- fitted_values(mod4_all, data = mdf_grp_diag, scale = "response")
mod5_all_pred <- fitted_values(mod5_all, data = mdf_grp_diag %>% filter(time > 8), scale = "response")



### Plot fitted models 
ggplot() +
  
  # add pct tested and scale by number tested
  geom_point(
    data = mdf_new_grp %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(Positive + Negative),
                obs_pct_pos = if_else(is.nan(sum(Positive)/sum(Positive + Negative)), 0, sum(Positive)/sum(Positive + Negative))),
    aes(x = time, y = obs_pct_pos, group = state_nm, size = num_tested), alpha = 0.5) +
  
  
        # Add in indications of when no cases were tested with xpert in a given period
  geom_point(
    data = mdf_new_grp %>%
      group_by(state_nm, time) %>%
      summarize(num_tested = sum(Positive + Negative),
                obs_pct_pos = if_else(is.nan(sum(Positive)/sum(Positive + Negative)), 0, sum(Positive)/sum(Positive + Negative))) %>% 
        filter(num_tested == 0),
      aes(x = time, y = num_tested), colour="black", shape=4, size=3) + 
  
  
    # add fitted values - Adjusted (health unit, sex, age, hiv status )
  geom_line(data = mod4_all_pred %>% 
                filter(!is.na(fitted)) %>% 
              group_by(state_nm, time) %>% 
              summarize(fitted = sum(fitted*cases)/sum(cases)), 
            aes(time, fitted, group = state_nm, color = "Model A - Adjusted")) +
  
      # add fitted values - Adjusted (health unit, sex, age, hiv status )
  geom_line(data = mod5_all_pred %>%
                filter(!is.na(fitted)) %>%
              group_by(state_nm, time) %>%
              summarize(fitted = sum(fitted*cases)/sum(cases)),
            aes(time, fitted, group = state_nm, color = "Model B - Adjusted, >2015")) +
  
  xlab("Quarter") + 
  ylab("Percent positive") + 
  ggtitle("All Cases") + 
  facet_wrap(~state_nm, scales = "free") + 
    theme_bw() + 
    theme(strip.background = element_blank(),
        strip.text = element_text(size = 11),
        panel.spacing = unit(3, "pt"), 
        # legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12), 
        title = element_text(size = 12)) +
  scale_size(
    range = c(0.5, 5)
  ) +
  labs(size = "Number of cases tested (Observed)", color = "Models",
        caption = "Note: An X denotes that 0 cases were tested with Xpert in a given quarter.") + 

scale_fill_manual(values = c("Fitted")) +
scale_color_manual(name="Lines",
                   labels=c("Model A - Adjusted",
                            "Model B - Adjusted, > 2015"),
                   values=c("red", "blue"))

```

* Time trends in RR-TB positivity (Model A - Adjusted): 

  * 2017: 
    * Average: 0.0405
    * Range: 0.017 (Goiás) - 0.0796 (Maranhão)
    * São Paulo: 0.0195
    
  * 2018: 
    * Average: 0.0358
    * Range: 0.0149 (Rio Grande do Norte) - 0.069 (Maranhão)
    * São Paulo: 0.0201
    
  * 2019: 
    * Average: 0.0281
    * Range: 0.0118 (Rio Grande do Norte) - 0.0509 (Maranhão)
    * São Paulo: 0.0183

\newpage

# Going Forward: 
* Add in FHS coverage 
* Try aggregating data to health region (to overcome noise when working with small municipalities)

